<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>留言板</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <script>
    const escapeOutput = (toOutput) => {
      return toOutput.replace(/\&/g, '&amp;')
        .replace(/\</g, '&lt;')
        .replace(/\>/g, '&gt;')
        .replace(/\"/g, '&quot;')
        .replace(/\'/g, '&#x27')
        .replace(/\//g, '&#x2F');
    }

    const appendCommentToDOM = (commentDOM, comment, isAppend) => {
      const html =
        `
              <div class="card comment mt-3">
                <div class="card-body">
                  <h5 class="card-title">${escapeOutput(comment.nickname)}</h5>
                  <h6 class="card-subtitle mb-2 text-muted">${escapeOutput(comment.created_at)}</h6>
                  <p class="card-text">${escapeOutput(comment.content)}</p>
                </div>
              </div>
              `
      if (isAppend) {
        commentDOM.append(html)
      } else {
        commentDOM.prepend(html)
      }
    }

    $(document).ready(() => {
      const commentsDom = $('.comments')

      $.ajax({
        method: 'GET',
        url: 'http://localhost:8888/week12_hw1/api_comments.php?site_key=1234',
        success: function (data) {
          if (data.ok) {
            alert(data.message)
            return
          }
          const comments = data
          comments.forEach((comment) => {
            appendCommentToDOM(commentsDom, comment, true)
          })
        },

        error: function (error) {
          console.log(error)
        }
      })

      $('.add__comment__form').on('submit', event => {
        event.preventDefault()
        const newComment = {
          site_key: '1234',
          nickname: $('input[name=nickname]').val(),
          content: $('textarea[name=content]').val()
        }
        $.ajax({
          type: 'POST',
          url: 'http://localhost:8888/week12_hw1/api_add_comments.php',
          data: newComment,
          success: function (data) {
            if (!data.ok) {
              alert(data.message)
              return
            }

            $('input[name=nickname]').val('')
            $('textarea[name=content]').val('')
            $.ajax({
              method: 'GET',
              url: 'http://localhost:8888/week12_hw1/api_comments.php?site_key=1234',
              success: function (data) {
                if (data.ok) {
                  alert(data.message)
                  return
                }
                const comments = data
                console.log(comments[0])
                appendCommentToDOM(commentsDom, comments[0], false)
              },

              error: function (error) {
                console.log(error)
              }
            })


          }
        })
      })
    })
  </script>
</head>

<body>
  <header>
    <nav class="navbar navbar-light bg-light">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">留言板</span>
      </div>
    </nav>
  </header>
  <div class="container">
    <div class="row add__comment mt-5">
      <form class="add__comment__form">
        <div class="mb-3">
          <label for="nickname" class="form-label">暱稱</label>
          <input type="text" class="form-control" id="nickname" name="nickname">
        </div>
        <div class="mb-3">
          <label for="content__textarea" class="form-label">留言內容</label>
          <textarea class="form-control" id="content__textarea" rows="5" name="content"></textarea>
        </div>
        <div>
          <button type="submit" class="btn btn-primary mb-3">送出</button>
        </div>
      </form>
    </div>
    <div class="row comments">
      <div class="fake"></div>
    </div>

    <template>
      <div class="card comment mt-3">
        <div class="card-body">
          <h5 class="card-title">留言者</h5>
          <h6 class="card-subtitle mb-2 text-muted">2020/05/20 22:30</h6>
          <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card's
            content.</p>
        </div>
      </div>
    </template>
</body>

</html>